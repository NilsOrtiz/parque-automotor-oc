# üîÑ Sistema de Sinergia Taller-Operaciones

## üìã Resumen del Sistema

Sistema completo que permite la coordinaci√≥n fluida entre el **Taller** (reportes y problemas) y **Operaciones** (coordinaci√≥n y programaci√≥n), manteniendo la integridad de datos en ambos sistemas.

---

## üéØ Arquitectura del Sistema

### **üõ†Ô∏è Lado Taller** (`pendientes_observaciones`)
- **Prop√≥sito**: Reportar problemas encontrados en veh√≠culos
- **Usuarios**: Personal de taller
- **Datos**: Problemas espec√≠ficos, clasificaciones t√©cnicas, descripci√≥n detallada
- **Estados**: `pendiente` ‚Üí `en_progreso` ‚Üí `completado` / `coordinado`

### **‚öôÔ∏è Lado Operaciones** (`pendientes_operaciones`)
- **Prop√≥sito**: Coordinar recursos y programar trabajos
- **Usuarios**: Coordinadores de operaciones
- **Datos**: Destinos, tiempos estimados, programaci√≥n, recursos
- **Estados**: `pendiente` ‚Üí `programado` ‚Üí `en_proceso` ‚Üí `completado`

### **üîó Puente de Sinergia**
- **Migraci√≥n inteligente** de pendientes del taller a operaciones
- **Preservaci√≥n de datos** en ambos sistemas
- **Trazabilidad completa** del flujo de trabajo
- **Flexibilidad de destinos** (Taller, IDISA, Taller Externo)

---

## üîÑ Flujo de Trabajo Completo

```mermaid
graph TD
    A[üîß Taller detecta problema] --> B[üìù Registra en pendientes_observaciones]
    B --> C[üëÄ Taller revisa lista de pendientes]
    C --> D{¬øRequiere coordinaci√≥n?}
    D -->|No| E[üîß Taller resuelve directamente]
    D -->|S√≠| F[üì§ Selecciona pendientes]
    F --> G[üéØ Elige destino]
    G --> H[üì° Migra a pendientes_operaciones]
    H --> I[‚úÖ Marca como 'coordinado' en taller]
    H --> J[üìã Crea registro en operaciones]
    J --> K[üë• Operaciones coordina]
    K --> L[üìÖ Programa trabajo]
    L --> M[üîß Ejecuta trabajo]
    M --> N[‚úÖ Completa en ambos sistemas]
```

---

## üóÑÔ∏è Estructura de Datos

### **Tabla `pendientes_observaciones` (Taller)**
```sql
CREATE TABLE pendientes_observaciones (
  id_pendiente SERIAL PRIMARY KEY,
  id INTEGER NOT NULL,                    -- vehiculo_id
  clasificacion TEXT NOT NULL,            -- "Motor", "Transmisi√≥n", etc.
  subclasificacion TEXT,                  -- Detalle espec√≠fico
  descripcion TEXT NOT NULL,              -- Descripci√≥n del problema
  prioridad TEXT CHECK (prioridad IN ('leve', 'medio', 'critico')),
  tiempo_estimado INTEGER,                -- Horas estimadas
  estado TEXT CHECK (estado IN ('pendiente', 'en_progreso', 'completado', 'coordinado')),
  coordinado_con TEXT,                    -- Destino de coordinaci√≥n
  fecha_coordinacion TIMESTAMP,          -- Cu√°ndo se coordin√≥
  -- ... otros campos
);
```

### **Tabla `pendientes_operaciones` (Operaciones)**
```sql
CREATE TABLE pendientes_operaciones (
  id SERIAL PRIMARY KEY,
  vehiculo_id INTEGER NOT NULL,
  interno INTEGER,                        -- N√∫mero interno del veh√≠culo
  placa TEXT NOT NULL,                    -- Placa del veh√≠culo
  trasladar_a TEXT DEFAULT 'Taller',     -- Destino del trabajo
  tiempo_estimado TEXT DEFAULT '4-6 horas', -- Tiempo en formato texto
  motivo TEXT,                           -- Raz√≥n del trabajo
  criticidad TEXT CHECK (criticidad IN ('leve', 'medio', 'critico')),
  estado TEXT CHECK (estado IN ('pendiente', 'programado', 'en_proceso', 'completado')),
  es_automatico BOOLEAN DEFAULT true,     -- true=sistema, false=manual
  -- ... campos t√©cnicos adicionales
);
```

---

## ‚öôÔ∏è Funciones SQL del Sistema

### **1. üîÑ Migraci√≥n Individual**
```sql
SELECT migrar_pendiente_a_operaciones(
  p_id_pendiente := 123,
  p_trasladar_a := 'IDISA'
);
```

**¬øQu√© hace?**
- Valida que el pendiente existe y est√° activo
- Verifica que no exista duplicado en operaciones
- Convierte datos del formato taller al formato operaciones
- Crea registro en `pendientes_operaciones`
- Marca original como `coordinado`

### **2. üì¶ Migraci√≥n Masiva**
```sql
SELECT migrar_pendientes_masivos(
  p_ids_pendientes := ARRAY[123, 124, 125],
  p_trasladar_a := 'Taller'
);
```

**¬øQu√© hace?**
- Procesa m√∫ltiples pendientes en una transacci√≥n
- Retorna resumen de √©xitos y fallos
- Maneja errores individuales sin afectar el batch

### **3. ‚Ü©Ô∏è Rollback de Migraci√≥n**
```sql
SELECT deshacer_migracion_pendiente(
  p_interno := 74,
  p_trasladar_a := 'IDISA'
);
```

**¬øQu√© hace?**
- Elimina registro de `pendientes_operaciones`
- Restaura estado original en `pendientes_observaciones`
- √ötil para correcci√≥n de errores

### **4. üìä Estad√≠sticas de Coordinaci√≥n**
```sql
SELECT estadisticas_coordinacion_pendientes();
```

**Retorna**:
- Total de pendientes por estado
- Distribuci√≥n por destino de coordinaci√≥n
- M√©tricas de prioridad
- An√°lisis temporal

---

## üñ•Ô∏è Interface de Usuario

### **üìã Lista de Pendientes (Taller)**
**Ubicaci√≥n**: `/vehiculos/lista-pendientes`

**Caracter√≠sticas**:
- ‚úÖ **Filtros avanzados**: Por flota, estado, prioridad
- ‚úÖ **Selecci√≥n m√∫ltiple**: Checkboxes para bulk actions
- ‚úÖ **Modal de migraci√≥n**: Selector de destino intuitivo
- ‚úÖ **Estados visuales**: Iconograf√≠a clara para coordinados
- ‚úÖ **Feedback en tiempo real**: Loading states y confirmaciones

**Flujo de Uso**:
1. Taller ve lista de problemas reportados
2. Selecciona problemas que requieren coordinaci√≥n
3. Click "Enviar a Operaciones"
4. Elige destino (Taller / IDISA / Taller Externo)
5. Confirma migraci√≥n
6. Sistema procesa y actualiza estados

### **‚öôÔ∏è Coordinaci√≥n de Operaciones**
**Ubicaci√≥n**: `/pendientes`

**Caracter√≠sticas**:
- ‚úÖ **Vista consolidada**: Autom√°ticos + Manuales
- ‚úÖ **Identificaci√≥n clara**: Marca origen (AUTO vs MANUAL)
- ‚úÖ **Gesti√≥n de estados**: Programaci√≥n y seguimiento
- ‚úÖ **Datos t√©cnicos**: Porcentajes de vida √∫til
- ‚úÖ **Edici√≥n directa**: Tiempos, destinos, observaciones

---

## üîß API Endpoints

### **POST `/api/migrar-pendiente`**
**Migraci√≥n Individual**:
```json
{
  "tipo": "individual",
  "id_pendiente": 123,
  "trasladar_a": "IDISA"
}
```

**Migraci√≥n Masiva**:
```json
{
  "tipo": "masivo",
  "ids_pendientes": [123, 124, 125],
  "trasladar_a": "Taller"
}
```

**Respuesta**:
```json
{
  "success": true,
  "message": "Migraci√≥n exitosa",
  "resultado": {
    "interno": 74,
    "placa": "ABC123",
    "trasladar_a": "IDISA",
    "tiempo_estimado": "4-6 horas"
  }
}
```

### **GET `/api/migrar-pendiente`**
**Estad√≠sticas de Coordinaci√≥n**:
```json
{
  "success": true,
  "estadisticas": {
    "total_pendientes": 45,
    "pendientes_activos": 12,
    "pendientes_coordinados": 8,
    "coordinacion_por_destino": {
      "Taller": 5,
      "IDISA": 2,
      "Taller Externo": 1
    }
  }
}
```

---

## üõ°Ô∏è Validaciones y Protecciones

### **‚úÖ Validaciones de Migraci√≥n**
- **Existencia**: Pendiente debe existir y estar activo
- **Duplicados**: No crear duplicados en mismo destino
- **Estados**: Solo migrar pendientes no completados
- **Datos requeridos**: Validar integridad de veh√≠culo

### **üîí Protecciones de Datos**
- **Preservaci√≥n**: Datos originales nunca se pierden
- **Trazabilidad**: Timestamps y audit trails completos
- **Rollback**: Capacidad de deshacer migraciones
- **Integridad**: Foreign keys y constraints

### **‚ö° Optimizaciones**
- **√çndices**: Para consultas r√°pidas por estado
- **Batch processing**: Migraciones masivas eficientes
- **Cacheo**: Estad√≠sticas pre-calculadas
- **Logs**: Monitoreo y debugging completo

---

## üìä Casos de Uso Pr√°cticos

### **üîß Caso 1: Problema Menor (Taller ‚Üí Taller)**
```
Problema: Luz check engine intermitente
Flujo: Taller detecta ‚Üí Taller migra a "Taller" ‚Üí Operaciones programa ‚Üí Taller resuelve
```

### **üè≠ Caso 2: Reparaci√≥n Mayor (Taller ‚Üí IDISA)**
```
Problema: Transmisi√≥n requiere overhaul
Flujo: Taller detecta ‚Üí Taller migra a "IDISA" ‚Üí Operaciones coordina traslado ‚Üí IDISA repara
```

### **üîß Caso 3: Especialidad Externa (Taller ‚Üí Taller Externo)**
```
Problema: Sistema el√©ctrico complejo
Flujo: Taller detecta ‚Üí Taller migra a "Taller Externo" ‚Üí Operaciones busca especialista ‚Üí Externo repara
```

### **üì¶ Caso 4: M√∫ltiples Problemas**
```
Situaci√≥n: 5 veh√≠culos necesitan service programado
Flujo: Taller selecciona todos ‚Üí Migraci√≥n masiva a "Taller" ‚Üí Operaciones programa batch
```

---

## üöÄ Beneficios del Sistema

### **Para el Taller**:
- ‚úÖ **Reportes simplificados**: Focus en detectar problemas
- ‚úÖ **Coordinaci√≥n autom√°tica**: No gestionar recursos externos
- ‚úÖ **Trazabilidad**: Seguimiento de todo el proceso
- ‚úÖ **Flexibilidad**: M√∫ltiples destinos seg√∫n necesidad

### **Para Operaciones**:
- ‚úÖ **Vista consolidada**: Todo en una sola interfaz
- ‚úÖ **Informaci√≥n rica**: Contexto t√©cnico + log√≠stico
- ‚úÖ **Programaci√≥n eficiente**: Batch processing y optimizaci√≥n
- ‚úÖ **Control total**: Edici√≥n de tiempos y destinos

### **Para la Organizaci√≥n**:
- ‚úÖ **Eficiencia operativa**: Menos coordinaci√≥n manual
- ‚úÖ **Visibilidad completa**: KPIs y m√©tricas en tiempo real
- ‚úÖ **Escalabilidad**: Sistema maneja vol√∫menes crecientes
- ‚úÖ **Integridad de datos**: Audit trail completo

---

## üîß Instalaci√≥n y Configuraci√≥n

### **1. Ejecutar Scripts SQL en Supabase**:
```sql
-- Orden de ejecuci√≥n:
1. sql/agregar_estado_coordinado.sql
2. sql/funcion_migrar_pendiente_a_operaciones.sql
```

### **2. Verificar Funciones**:
```sql
-- Test b√°sico
SELECT estadisticas_coordinacion_pendientes();

-- Test de migraci√≥n (con datos reales)
SELECT migrar_pendiente_a_operaciones(ID_REAL, 'Taller');
```

### **3. Configurar Permisos**:
```sql
-- Asegurar que las funciones son ejecutables por la aplicaci√≥n
GRANT EXECUTE ON FUNCTION migrar_pendiente_a_operaciones TO authenticated;
GRANT EXECUTE ON FUNCTION migrar_pendientes_masivos TO authenticated;
GRANT EXECUTE ON FUNCTION estadisticas_coordinacion_pendientes TO authenticated;
```

### **4. Deploy de la Aplicaci√≥n**:
```bash
# Los cambios ya est√°n commiteados
git push origin main

# Vercel desplegar√° autom√°ticamente
```

---

## üéØ Pr√≥ximos Pasos Opcionales

### **Mejoras Futuras**:
1. **üìä Dashboard de m√©tricas**: Visualizaci√≥n avanzada de coordinaci√≥n
2. **üì± Notificaciones**: Alerts autom√°ticos por estado
3. **ü§ñ IA predictiva**: Sugerencias de destino seg√∫n historial
4. **üìã Reportes autom√°ticos**: Consolidados semanales/mensuales
5. **üîÑ Sincronizaci√≥n bidirecional**: Updates autom√°ticos entre sistemas

### **Integraciones**:
1. **üìß Email notifications**: Alerts a responsables por destino
2. **üìÖ Calendario integrado**: Programaci√≥n visual avanzada
3. **üìä Analytics**: KPIs y m√©tricas de performance
4. **üîó API externa**: Integraci√≥n con sistemas de terceros

---

**üéâ El sistema est√° listo y operativo. La sinergia entre Taller y Operaciones es ahora fluida, trazable y eficiente!**