name: ðŸ”„ Actualizar Pendientes de Operaciones

on:
  schedule:
    # Ejecutar mÃºltiples veces al dÃ­a
    - cron: '0 6 * * *'   # 6:00 AM UTC (3:00 AM Argentina)
    - cron: '0 14 * * *'  # 2:00 PM UTC (11:00 AM Argentina)
    - cron: '0 18 * * *'  # 6:00 PM UTC (3:00 PM Argentina)

  # Permitir ejecuciÃ³n manual desde GitHub
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Forzar actualizaciÃ³n completa'
        required: false
        default: 'false'
        type: boolean

jobs:
  actualizar-pendientes:
    name: ðŸš› Actualizar Lista de Pendientes
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸš€ Iniciar proceso
        run: |
          echo "ðŸ•’ Iniciando actualizaciÃ³n automÃ¡tica de pendientes..."
          echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ðŸŒ Timezone: $TZ"
          echo "ðŸ”§ Forzar actualizaciÃ³n: ${{ github.event.inputs.force_update || 'false' }}"

      - name: ðŸ” Verificar estado de la aplicaciÃ³n
        run: |
          echo "ðŸ“¡ Verificando que la aplicaciÃ³n estÃ© disponible..."
          echo "ðŸ”— URL base: ${{ secrets.APP_URL }}"

          # Probar endpoint de salud simple primero
          health_url="${{ secrets.APP_URL }}/api/health"
          echo "ðŸ¥ Probando health endpoint: $health_url"

          health_response=$(curl -s -w "%{http_code}" \
            -m 10 \
            -H "User-Agent: GitHubActions/HealthCheck" \
            "$health_url")

          health_code="${health_response: -3}"
          health_body="${health_response%???}"

          echo "ðŸ¥ Health check status: $health_code"
          echo "ðŸ“‹ Health response: $health_body"

          # Verificar pÃ¡gina principal tambiÃ©n
          main_check=$(curl -s -o /dev/null -w "%{http_code}" \
            -m 10 \
            "${{ secrets.APP_URL }}" || echo "000")

          echo "ðŸŒ Main page status: $main_check"

          if [ "$health_code" != "200" ] && [ "$main_check" != "200" ]; then
            echo "âš ï¸ La aplicaciÃ³n no estÃ¡ respondiendo correctamente"
            echo "ðŸ”— URLs verificadas: health=$health_url, main=${{ secrets.APP_URL }}"
            # No fallar, continuar con el intento
          else
            echo "âœ… AplicaciÃ³n disponible"
          fi

      - name: ðŸ“Š Consultar estado actual
        id: current_state
        run: |
          echo "ðŸ“‹ Consultando estado actual de pendientes..."
          echo "ðŸ”— URL base: ${{ secrets.APP_URL }}"

          # Usar GET para consultar estado sin ejecutar actualizaciÃ³n
          api_url="${{ secrets.APP_URL }}/api/actualizar-pendientes"
          echo "ðŸŽ¯ URL completa: $api_url"

          current_response=$(curl -s -w "%{http_code}" \
            -m 30 \
            -H "Content-Type: application/json" \
            -H "User-Agent: GitHubActions/PendientesUpdater" \
            -H "Accept: application/json" \
            -L \
            "$api_url")

          current_http_code="${current_response: -3}"
          current_body="${current_response%???}"

          echo "ðŸ“Š Estado actual - CÃ³digo HTTP: $current_http_code"
          echo "ðŸ“‹ Respuesta: $current_body"

          # Guardar para el siguiente step
          echo "current_status=$current_http_code" >> $GITHUB_OUTPUT
          echo "current_data=$current_body" >> $GITHUB_OUTPUT

      - name: ðŸ”„ Ejecutar actualizaciÃ³n de pendientes
        id: update
        run: |
          echo "ðŸ”„ Ejecutando actualizaciÃ³n de pendientes..."
          echo "ðŸ”— URL base: ${{ secrets.APP_URL }}"

          # Construir URL completa para cron endpoint
          cron_url="${{ secrets.APP_URL }}/api/cron/actualizar-pendientes"
          echo "ðŸŽ¯ URL cron completa: $cron_url"

          # Construir headers
          headers=(-H "Content-Type: application/json" -H "User-Agent: GitHubActions/AutoUpdater" -H "Accept: application/json")

          # Agregar token si estÃ¡ configurado
          if [ -n "${{ secrets.CRON_SECRET_TOKEN }}" ]; then
            headers+=(-H "Authorization: Bearer ${{ secrets.CRON_SECRET_TOKEN }}")
            echo "ðŸ” Token de autorizaciÃ³n configurado"
          else
            echo "âš ï¸ No hay token de autorizaciÃ³n configurado"
          fi

          # Ejecutar actualizaciÃ³n con follow redirects
          update_response=$(curl -s -w "%{http_code}" \
            -X POST \
            -m 30 \
            -L \
            "${headers[@]}" \
            "$cron_url")

          update_http_code="${update_response: -3}"
          update_body="${update_response%???}"

          echo "ðŸ“Š ActualizaciÃ³n - CÃ³digo HTTP: $update_http_code"
          echo "ðŸ“‹ Respuesta completa: $update_body"

          # Guardar resultados
          echo "update_status=$update_http_code" >> $GITHUB_OUTPUT
          echo "update_data=$update_body" >> $GITHUB_OUTPUT

          # Extraer informaciÃ³n especÃ­fica si la respuesta es JSON vÃ¡lida
          if command -v jq >/dev/null 2>&1; then
            if echo "$update_body" | jq . >/dev/null 2>&1; then
              registros=$(echo "$update_body" | jq -r '.registros_insertados // "N/A"')
              success=$(echo "$update_body" | jq -r '.success // false')
              message=$(echo "$update_body" | jq -r '.message // "N/A"')

              echo "ðŸ“ˆ Registros insertados: $registros"
              echo "âœ… Ã‰xito: $success"
              echo "ðŸ’¬ Mensaje: $message"

              echo "registros_insertados=$registros" >> $GITHUB_OUTPUT
              echo "success=$success" >> $GITHUB_OUTPUT
              echo "message=$message" >> $GITHUB_OUTPUT
            fi
          fi

      - name: ðŸ“ˆ Procesar resultados
        run: |
          echo "ðŸ“Š Procesando resultados de la actualizaciÃ³n..."

          update_status="${{ steps.update.outputs.update_status }}"
          success="${{ steps.update.outputs.success }}"
          registros="${{ steps.update.outputs.registros_insertados }}"
          message="${{ steps.update.outputs.message }}"

          echo "ðŸ” Estado HTTP: $update_status"
          echo "âœ… Ã‰xito: $success"
          echo "ðŸ“Š Registros procesados: $registros"
          echo "ðŸ’¬ Mensaje: $message"

          if [ "$update_status" = "200" ] && [ "$success" = "true" ]; then
            echo "ðŸŽ‰ Â¡ActualizaciÃ³n completada exitosamente!"
            echo "ðŸ“ˆ Se procesaron $registros registros"

            # Crear resumen para GitHub
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… ActualizaciÃ³n Exitosa

          **ðŸ•’ Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **ðŸ“Š Registros procesados:** $registros
          **ðŸ’¬ Mensaje:** $message
          **ðŸ”— Endpoint:** \`/api/cron/actualizar-pendientes\`

          ### ðŸ“‹ PrÃ³ximos pasos
          - Los pendientes estÃ¡n disponibles en [/pendientes](${{ secrets.APP_URL }}/pendientes)
          - Los registros automÃ¡ticos pueden editarse en Supabase
          - El prÃ³ximo update se ejecutarÃ¡ segÃºn el schedule configurado
          EOF

          else
            echo "âŒ Error en la actualizaciÃ³n"
            echo "ðŸ” CÃ³digo de estado: $update_status"
            echo "ðŸ“‹ Respuesta: ${{ steps.update.outputs.update_data }}"

            # Crear resumen de error
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âŒ Error en ActualizaciÃ³n

          **ðŸ•’ Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **ðŸ” CÃ³digo HTTP:** $update_status
          **ðŸ’¬ Mensaje:** $message
          **ðŸ“‹ Respuesta completa:** \`${{ steps.update.outputs.update_data }}\`

          ### ðŸ”§ Posibles soluciones
          - Verificar que la aplicaciÃ³n estÃ© funcionando
          - Revisar la configuraciÃ³n de secrets en GitHub
          - Ejecutar manualmente desde [/pendientes](${{ secrets.APP_URL }}/pendientes)
          EOF

            exit 1
          fi

      - name: ðŸ§¹ Cleanup y resumen final
        if: always()
        run: |
          echo "ðŸ§¹ Finalizando proceso..."
          echo "â±ï¸ DuraciÃ³n total: $SECONDS segundos"
          echo "ðŸ”„ Workflow completado: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          # Log para debugging
          echo "ðŸ” Variables de entorno relevantes:"
          echo "GITHUB_WORKFLOW: $GITHUB_WORKFLOW"
          echo "GITHUB_RUN_ID: $GITHUB_RUN_ID"
          echo "GITHUB_RUN_NUMBER: $GITHUB_RUN_NUMBER"